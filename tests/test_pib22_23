"""
PROJETO: ANALISE DO CAPITAL COGNITIVO NO BRASIL POR UF
ARQUIVO: 04_extrair_pib_capita_direto.py
DESCRICAO: Extrai PIB per capita (Var 6564) de 2022 e 2023 e
           gera estatisticas descritivas e de correlacao.
"""

import requests
import pandas as pd
import os

# =========================
# CONFIGURAÇÕES
# =========================

ANOS_REFERENCIA = "2022,2023" 

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
DIR_OUT_CSV = os.path.join(BASE_DIR, "analise_exploratoria", "ind_se", "csv")
DIR_OUT_XLSX = os.path.join(BASE_DIR, "analise_exploratoria", "ind_se", "xlsx")

os.makedirs(DIR_OUT_CSV, exist_ok=True)
os.makedirs(DIR_OUT_XLSX, exist_ok=True)

OUT_CSV = os.path.join(DIR_OUT_CSV, "dados_pib_per_capita_2022_2023.csv")
OUT_XLSX = os.path.join(DIR_OUT_XLSX, "dados_pib_per_capita_2022_2023.xlsx")


# =========================
# FUNÇÕES DE EXTRAÇÃO
# =========================

def obter_pib_per_capita_oficial(anos: str) -> pd.DataFrame:
    print(f">>> Consultando API SIDRA para os anos: {anos}...")
    url = (
        "https://servicodados.ibge.gov.br/api/v3/agregados/5938/"
        f"periodos/{anos}/variaveis/6564?localidades=N3[all]"
    )
    try:
        r = requests.get(url, timeout=30)
        r.raise_for_status()
        data = r.json()
    except Exception as e:
        print(f"Erro na conexão com IBGE: {e}")
        return pd.DataFrame()

    registros = []
    if not data: return pd.DataFrame()

    for item in data[0]["resultados"][0]["series"]:
        for ano, valor in item["serie"].items():
            val_float = float(valor) if valor and valor not in ["-", "..."] else None
            registros.append({
                "codigo_uf": int(item["localidade"]["id"]),
                "uf": item["localidade"]["nome"],
                "ano": int(ano),
                "pib_per_capita_r$": val_float
            })

    return pd.DataFrame(registros).sort_values(["uf", "ano"])


# =========================
# FUNÇÕES DE ESTATÍSTICA
# =========================

def gerar_tabela_estatistica(df_pivot):
    """
    Gera um DataFrame com Médias, Desvios e Correlações.
    Esperado df_pivot com colunas: ['uf', 2022, 2023]
    """
    cols_anos = [c for c in df_pivot.columns if c in [2022, 2023]]
    
    # 1. Estatísticas Descritivas
    desc = df_pivot[cols_anos].describe().T
    desc = desc[['mean', 'std', 'min', 'max', '50%']]
    desc.columns = ['Media', 'Desvio_Padrao', 'Minimo', 'Maximo', 'Mediana']
    
    # 2. Correlações
    # Pearson: Mede relação linear (valores exatos)
    corr_pearson = df_pivot[2022].corr(df_pivot[2023], method='pearson')
    # Spearman: Mede relação de postos (ranking) - Importante para seu estudo!
    corr_spearman = df_pivot[2022].corr(df_pivot[2023], method='spearman')
    
    print("\n>>> RESULTADOS ESTATÍSTICOS <<<")
    print(desc)
    print("-" * 30)
    print(f"Correlação de Pearson (Valor):  {corr_pearson:.4f}")
    print(f"Correlação de Spearman (Rank):  {corr_spearman:.4f}")
    
    # Cria um DF de resumo das correlações para salvar no Excel
    df_corr = pd.DataFrame({
        'Metrica': ['Correlacao Pearson (Linear)', 'Correlacao Spearman (Ranking)'],
        'Valor': [corr_pearson, corr_spearman],
        'Interpretacao': [
            'Alta estabilidade de valores' if corr_pearson > 0.9 else 'Instabilidade de valores',
            'Alta estabilidade de posições' if corr_spearman > 0.9 else 'Mudança significativa no ranking'
        ]
    })
    
    return desc, df_corr


# =========================
# PIPELINE PRINCIPAL
# =========================

def processar_dados():
    try:
        df_final = obter_pib_per_capita_oficial(ANOS_REFERENCIA)
        if df_final.empty: raise ValueError("Sem dados.")
    except ValueError as ve:
        print(ve); return

    # Pivotar para colunas 2022 e 2023 ficarem lado a lado
    df_pivot = df_final.pivot(index=['codigo_uf', 'uf'], columns='ano', values='pib_per_capita_r$').reset_index()
    df_pivot.columns.name = None # Remove nome da hierarquia

    # Calcular Variação Percentual (Diferença Nominal)
    if 2022 in df_pivot.columns and 2023 in df_pivot.columns:
        df_pivot['Variacao_%'] = ((df_pivot[2023] - df_pivot[2022]) / df_pivot[2022]) * 100

    # Gerar Estatísticas
    df_stats_desc, df_stats_corr = gerar_tabela_estatistica(df_pivot)

    # Exportação Multi-Abas
    with pd.ExcelWriter(OUT_XLSX) as writer:
        df_final.to_excel(writer, sheet_name="DADOS_BRUTOS", index=False)
        df_pivot.to_excel(writer, sheet_name="VISAO_COMPARATIVA", index=False)
        df_stats_desc.to_excel(writer, sheet_name="ESTATISTICAS_DESCRITIVAS")
        df_stats_corr.to_excel(writer, sheet_name="CORRELACOES", index=False)
    
    df_final.to_csv(OUT_CSV, sep=";", index=False, encoding="utf-8-sig")

    print(f"\nArquivo gerado com sucesso: {OUT_XLSX}")

if __name__ == "__main__":
    processar_dados()